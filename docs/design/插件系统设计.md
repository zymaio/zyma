# Zyma 插件系统架构设计 (v1.1)

> **核心目标**：构建一个高性能、极致解耦、且具备标准 IDE 扩展能力的开发底座。

---

## 1. 分层架构：微内核 + 桥接 + 业务插件

Zyma 采用典型的“三层解耦”架构，确保性能与灵活性并存：

### 1.1 内核层 (Rust / Tauri Core)
*   **计算下沉**：所有的重型任务（文件监听 `notify`、Glob 搜索 `globset`、多线程 IO）均由 Rust 后端承载。
*   **状态权威**：通过全局 `AppState` 维护权威的工作区路径、输出缓存和窗口句柄。
*   **事件总线**：利用 Tauri 事件总线实现全系统级的广播（如 `workspace_changed`, `file_saved`）。

### 1.2 桥接层 (Plugin API Store)
*   **职责分离**：
    *   **PluginManager**：负责插件的生命周期（扫描、加载、卸载、禁用）。
    *   **PluginAPIBuilder**：专门负责构建注入给插件的 `zyma` API 对象，实现 API 的版本控制与权限隔离。
*   **事件映射**：将后端原始的下划线事件（`fs_create`）映射为标准接口（`onDidCreateFiles`）。

### 1.3 插件层 (JS / React Plugins)
*   **逻辑自闭环**：插件通过闭包持有私有状态，不污染宿主全局环境。
*   **UI 动态注册**：支持动态注入侧边栏视图 (`SidebarView`) 和状态栏项。

---

## 2. 事件驱动模型 (Event-driven API)

Zyma 复刻了 VS Code 的核心心智模型，支持插件对用户行为的敏锐感知：

| 命名空间 | 事件接口 | 触发时机 |
| :--- | :--- | :--- |
| **`workspace`** | `onDidSaveTextDocument` | 文件写入磁盘成功后 |
| **`workspace`** | `onDidCreateFiles` | Rust 捕获到新文件生成 |
| **`window`** | `onDidChangeActiveTextEditor` | 用户切换标签页或打开新文件 |
| **`window`** | `onDidChangeWindowState` | Zyma 获得或失去焦点 |
| **`window`** | `onDidChangeTextEditorSelection` | 光标移动或选区变化 (节流处理) |

---

## 3. 内存与稳定性保障

1.  **自动销毁 (Disposables)**：所有插件订阅的事件监听器都会在插件卸载或禁用时由 `PluginManager` 自动执行清理，彻底杜绝监听器堆积。
2.  **路径标准化 (Normalization)**：内置 `pathUtils` 工具，确保跨平台（Win/Mac/Linux）路径对比的一致性。
3.  **多屏隔离**：独立日志窗口具备坐标记忆能力，自动适配多屏 DPI 差异。

---

## 4. 开发规范

1.  **资源管理**：插件注册的所有视图和命令必须在清单 (`manifest.json`) 中声明，以便宿主进行权限核验。
2.  **性能准则**：禁止在插件 JS 环境中执行大数组遍历或复杂正则，应通过 `zyma.system.exec` 或专用 API 委托给内核处理。
