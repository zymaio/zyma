# Zyma 插件系统架构设计 (v1.0)

> **核心目标**：构建一个高性能、解耦且具备 IDE 扩展能力的编辑器基座。通过 Rust 承载重型任务，通过 JS 插件实现业务灵活性。

---

## 1. 架构模型：微内核 + 动态插件

Zyma 采用了典型的“宿主-插件”架构，将系统划分为三层：

### 1.1 内核层 (Rust / Tauri Core)
*   **职责**: 提供高性能、低延迟的底层能力。
*   **核心引擎**:
    *   **Search Engine**: 基于 `globset` 和 `walkdir` 的多线程文件扫描。
    *   **Watcher Engine**: 基于 `notify` 的实时文件系统监听。
    *   **Log Engine**: 具备循环缓存（Ring Buffer）的输出通道管理。
    *   **Window Manager**: 原生窗口的生命周期调度。

### 1.2 桥接层 (Tauri Commands / PluginManager)
*   **职责**: 安全地将内核能力暴露给插件。
*   **API 注入**: 在加载插件时，通过 `new Function` 注入全局 `zyma` 对象。
*   **类型安全**: 提供完整的 `ZymaAPI` TypeScript 定义。

### 1.3 插件层 (JS / React Plugins)
*   **职责**: 具体的业务编排与 UI 展示。
*   **特性**: 零编译运行。插件直接使用注入的 `React` 和 `Lucide` 库进行 UI 构建。

---

## 2. 核心 API 矩阵 (对标 VS Code)

为了降低开发门槛，Zyma 的 API 设计严格参考了 VS Code 的心智模型：

| 命名空间 | 核心函数 | 功能描述 |
| :--- | :--- | :--- |
| **`workspace`** | `findFiles`, `stat`, `watch` | 高性能文件查找、元数据读取与实时监听 |
| **`system`** | `exec`, `getEnv` | 安全执行外部程序（如 Python）与环境变量读取 |
| **`window`** | `createOutputChannel` | 按需激活的日志控制台系统 |
| **`views`** | `register` | 动态侧边栏视图注入 |

---

## 3. 特色设计：按需激活的输出系统

不同于传统 IDE 永久占用底部空间，Zyma 实现了“幽灵式”控制台：
1.  **静默状态**: 启动时图标和面板均隐藏。
2.  **触发显示**: 一旦插件向 `OutputChannel` 写入日志，左下角自动浮现 `Monitor` 图标。
3.  **独立调度**: 支持将日志面板一键弹出为独立的原生窗口，实现多屏监控。

---

## 4. 插件开发规范

1. **生命周期**: 插件通过 `activate(zyma, React, Lucide)` 钩子注入。
2. **UI 隔离**: 建议每个插件注册独立的 `SidebarView` 或使用独立的 `OutputChannel`。
3. **资源管理**: 使用 `FileSystemWatcher` 必须在插件卸载时调用 `dispose()` 释放 Rust 句柄。

---

## 5. 性能保障原则

*   **计算下沉**: 凡是涉及大目录扫描、正则匹配、高频文件监听的逻辑，必须在 Rust 侧实现。
*   **数据缓冲**: 大量日志输出时，Rust 负责限流与分批推送，避免 JS 线程阻塞。
*   **按需加载**: 仅在用户激活特定视图时才挂载对应的 React 组件。